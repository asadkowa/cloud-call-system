<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<document type="freeswitch/xml">
  <section name="configuration" description="FreeSWITCH Configuration">
    <configuration name="modules.conf" description="Modules">
      <modules>
        <!-- Event Socket -->
        <load module="mod_event_socket"/>

        <!-- Loggers -->
        <load module="mod_console"/>
        <load module="mod_logfile"/>

        <!-- Multi-Faceted -->
        <load module="mod_enum"/>
        <load module="mod_xml_cdr"/>
        <load module="mod_cdr_csv"/>

        <!-- XML Interfaces -->
        <load module="mod_xml_rpc"/>

        <!-- Languages -->
        <load module="mod_lua"/>

        <!-- Applications -->
        <load module="mod_commands"/>
        <load module="mod_conference"/>
        <load module="mod_db"/>
        <load module="mod_dptools"/>
        <load module="mod_expr"/>
        <load module="mod_fifo"/>
        <load module="mod_hash"/>
        <load module="mod_voicemail"/>
        <load module="mod_esf"/>
        <load module="mod_fsv"/>

        <!-- Dialplan Interfaces -->
        <load module="mod_dialplan_xml"/>

        <!-- Codec Interfaces -->
        <load module="mod_spandsp"/>
        <load module="mod_g723_1"/>
        <load module="mod_g729"/>
        <load module="mod_amr"/>

        <!-- File Format Interfaces -->
        <load module="mod_native_file"/>
        <load module="mod_sndfile"/>
        <load module="mod_local_stream"/>
        <load module="mod_tone_stream"/>

        <!-- Timers -->
        <load module="mod_sofia"/>

        <!-- Endpoints -->
        <load module="mod_loopback"/>

        <!-- Say -->
        <load module="mod_say_en"/>
      </modules>
    </configuration>

    <!-- Event Socket Library Configuration -->
    <configuration name="event_socket.conf" description="Socket Client">
      <settings>
        <param name="nat-map" value="false"/>
        <param name="listen-ip" value="0.0.0.0"/>
        <param name="listen-port" value="8021"/>
        <param name="password" value="ClueCon"/>
        <param name="apply-inbound-acl" value="loopback.auto"/>
      </settings>
    </configuration>

    <!-- Console Configuration -->
    <configuration name="console.conf" description="Console Logger">
      <mappings>
        <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
      </mappings>
      <settings>
        <param name="colorize" value="true"/>
        <param name="loglevel" value="info"/>
      </settings>
    </configuration>

    <!-- Logfile Configuration -->
    <configuration name="logfile.conf" description="File Logging">
      <settings>
        <param name="rotate-on-hup" value="true"/>
      </settings>
      <profiles>
        <profile name="default">
          <settings>
            <param name="logfile" value="/var/log/freeswitch/freeswitch.log"/>
            <param name="rollover" value="10485760"/>
            <param name="maximum-rotate" value="32"/>
            <param name="uuid" value="true"/>
          </settings>
          <mappings>
            <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
          </mappings>
        </profile>
      </profiles>
    </configuration>

    <!-- Switch Configuration -->
    <configuration name="switch.conf" description="Core Configuration">
      <settings>
        <param name="colorize-console" value="true"/>
        <param name="max-sessions" value="1000"/>
        <param name="sessions-per-second" value="30"/>
        <param name="loglevel" value="info"/>
        <param name="auto-restart" value="false"/>
        <param name="crash-protection" value="false"/>
      </settings>
    </configuration>

    <!-- Sofia SIP Configuration -->
    <configuration name="sofia.conf" description="Sofia SIP Stack">
      <global_settings>
        <param name="log-level" value="0"/>
        <param name="auto-restart" value="false"/>
        <param name="debug-presence" value="0"/>
      </global_settings>

      <profiles>
        <profile name="internal">
          <aliases></aliases>
          <gateways></gateways>
          <domains>
            <domain name="all" alias="false" parse="true"/>
          </domains>
          <settings>
            <param name="user-agent-string" value="CloudCallCenter PBX"/>
            <param name="debug" value="0"/>
            <param name="sip-trace" value="no"/>
            <param name="sip-capture" value="no"/>
            <param name="rfc2833-pt" value="101"/>
            <param name="sip-port" value="5060"/>
            <param name="dialplan" value="XML"/>
            <param name="context" value="default"/>
            <param name="dtmf-duration" value="2000"/>
            <param name="inbound-codec-prefs" value="PCMU,PCMA,G722"/>
            <param name="outbound-codec-prefs" value="PCMU,PCMA,G722"/>
            <param name="rtp-timer-name" value="soft"/>
            <param name="local-network-acl" value="localnet.auto"/>
            <param name="manage-presence" value="true"/>
            <param name="inbound-codec-negotiation" value="generous"/>
            <param name="nonce-ttl" value="60"/>
            <param name="auth-calls" value="true"/>
            <param name="inbound-late-negotiation" value="true"/>
            <param name="inbound-zrtp-passthru" value="true"/>
            <param name="rtp-ip" value="auto"/>
            <param name="sip-ip" value="auto"/>
            <param name="hold-music" value="local_stream://moh"/>
            <param name="apply-nat-acl" value="nat.auto"/>
            <param name="apply-inbound-acl" value="default"/>
            <param name="record-path" value="/var/lib/freeswitch/recordings"/>
            <param name="record-template" value="${caller_id_number}.${target_domain}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"/>
          </settings>
        </profile>

        <profile name="external">
          <aliases></aliases>
          <gateways></gateways>
          <domains>
            <domain name="all" alias="false" parse="false"/>
          </domains>
          <settings>
            <param name="user-agent-string" value="CloudCallCenter PBX"/>
            <param name="debug" value="0"/>
            <param name="sip-trace" value="no"/>
            <param name="sip-capture" value="no"/>
            <param name="rfc2833-pt" value="101"/>
            <param name="sip-port" value="5080"/>
            <param name="dialplan" value="XML"/>
            <param name="context" value="public"/>
            <param name="dtmf-duration" value="2000"/>
            <param name="inbound-codec-prefs" value="PCMU,PCMA,G722"/>
            <param name="outbound-codec-prefs" value="PCMU,PCMA,G722"/>
            <param name="rtp-timer-name" value="soft"/>
            <param name="manage-presence" value="false"/>
            <param name="inbound-codec-negotiation" value="generous"/>
            <param name="nonce-ttl" value="60"/>
            <param name="auth-calls" value="false"/>
            <param name="inbound-late-negotiation" value="true"/>
            <param name="rtp-ip" value="auto"/>
            <param name="sip-ip" value="auto"/>
            <param name="apply-inbound-acl" value="default"/>
            <param name="record-path" value="/var/lib/freeswitch/recordings"/>
          </settings>
        </profile>
      </profiles>
    </configuration>
  </section>

  <!-- Dialplan -->
  <section name="dialplan" description="Regex/XML Dialplan">
    <context name="default">
      <extension name="local_extension">
        <condition field="destination_number" expression="^(\d{3,4})$">
          <action application="export" data="dialed_extension=$1"/>
          <action application="bind_meta_app" data="1 b s execute_extension::dx XML features"/>
          <action application="bind_meta_app" data="2 b s record_session::/var/lib/freeswitch/recordings/${caller_id_number}.${strftime(%Y-%m-%d-%H-%M-%S)}.wav"/>
          <action application="bind_meta_app" data="3 b s execute_extension::cf XML features"/>
          <action application="set" data="ringback=${us-ring}"/>
          <action application="set" data="transfer_ringback=${us-ring}"/>
          <action application="set" data="call_timeout=30"/>
          <action application="set" data="hangup_after_bridge=true"/>
          <action application="set" data="continue_on_fail=true"/>
          <action application="bridge" data="user/${dialed_extension}@${domain_name}"/>
          <action application="answer"/>
          <action application="sleep" data="1000"/>
          <action application="voicemail" data="default ${domain_name} ${dialed_extension}"/>
        </condition>
      </extension>

      <extension name="group_dial_sales">
        <condition field="destination_number" expression="^(sales|1000)$">
          <action application="bridge" data="group/sales@${domain_name}"/>
        </condition>
      </extension>

      <extension name="group_dial_support">
        <condition field="destination_number" expression="^(support|2000)$">
          <action application="bridge" data="group/support@${domain_name}"/>
        </condition>
      </extension>
    </context>

    <context name="public">
      <extension name="public_did">
        <condition field="destination_number" expression="^(\d+)$">
          <action application="set" data="domain_name=${domain_name}"/>
          <action application="transfer" data="1000 XML default"/>
        </condition>
      </extension>
    </context>
  </section>

  <!-- Directory -->
  <section name="directory" description="User Directory">
    <domain name="${domain_name}">
      <params>
        <param name="dial-string" value="{^^:sip_invite_domain=${dialed_domain}:presence_id=${dialed_user}@${dialed_domain}}${sofia_contact(*/${dialed_user}@${dialed_domain})}"/>
        <param name="jsonrpc-allowed-methods" value="verto"/>
      </params>
      <variables>
        <variable name="record_stereo" value="true"/>
        <variable name="default_gateway" value="${default_provider}"/>
        <variable name="default_areacode" value="${default_areacode}"/>
        <variable name="transfer_fallback_extension" value="operator"/>
      </variables>
      <groups>
        <group name="default">
          <users>
            <!-- Users will be populated dynamically -->
          </users>
        </group>
      </groups>
    </domain>
  </section>
</document>